Index: openssl-1.0.1r/apps/enc.c
===================================================================
--- openssl-1.0.1r.orig/apps/enc.c	2016-01-28 21:38:30.000000000 +0800
+++ openssl-1.0.1r/apps/enc.c	2018-09-26 18:40:00.212071622 +0800
@@ -465,8 +465,10 @@
 #ifdef ZLIB
 
     if (do_zlib) {
+	#ifndef OPENSSL_NO_COMP
         if ((bzl = BIO_new(BIO_f_zlib())) == NULL)
             goto end;
+	#endif
         if (enc)
             wbio = BIO_push(bzl, wbio);
         else
Index: openssl-1.0.1r/crypto/cms/cms_cd.c
===================================================================
--- openssl-1.0.1r.orig/crypto/cms/cms_cd.c	2016-01-28 21:38:30.000000000 +0800
+++ openssl-1.0.1r/crypto/cms/cms_cd.c	2018-09-26 18:40:07.172960795 +0800
@@ -111,6 +111,7 @@
 
     return NULL;
 }
+#ifndef OPENSSL_NO_COMP
 
 BIO *cms_CompressedData_init_bio(CMS_ContentInfo *cms)
 {
@@ -130,5 +131,5 @@
     }
     return BIO_new(BIO_f_zlib());
 }
-
+#endif
 #endif
Index: openssl-1.0.1r/crypto/cms/cms_err.c
===================================================================
--- openssl-1.0.1r.orig/crypto/cms/cms_err.c	2016-01-28 22:00:36.000000000 +0800
+++ openssl-1.0.1r/crypto/cms/cms_err.c	2018-09-26 18:40:15.713315436 +0800
@@ -81,8 +81,10 @@
     {ERR_FUNC(CMS_F_CMS_ADD1_SIGNINGTIME), "CMS_ADD1_SIGNINGTIME"},
     {ERR_FUNC(CMS_F_CMS_COMPRESS), "CMS_compress"},
     {ERR_FUNC(CMS_F_CMS_COMPRESSEDDATA_CREATE), "cms_CompressedData_create"},
+#ifndef OPENSSL_NO_COMP
     {ERR_FUNC(CMS_F_CMS_COMPRESSEDDATA_INIT_BIO),
      "cms_CompressedData_init_bio"},
+#endif     
     {ERR_FUNC(CMS_F_CMS_COPY_CONTENT), "CMS_COPY_CONTENT"},
     {ERR_FUNC(CMS_F_CMS_COPY_MESSAGEDIGEST), "CMS_COPY_MESSAGEDIGEST"},
     {ERR_FUNC(CMS_F_CMS_DATA), "CMS_data"},
Index: openssl-1.0.1r/crypto/cms/cms_lcl.h
===================================================================
--- openssl-1.0.1r.orig/crypto/cms/cms_lcl.h	2016-01-28 22:00:36.000000000 +0800
+++ openssl-1.0.1r/crypto/cms/cms_lcl.h	2018-09-26 18:40:21.045427941 +0800
@@ -413,8 +413,9 @@
 int cms_SignerIdentifier_cert_cmp(CMS_SignerIdentifier *sid, X509 *cert);
 
 CMS_ContentInfo *cms_CompressedData_create(int comp_nid);
+#ifndef OPENSSL_NO_COMP
 BIO *cms_CompressedData_init_bio(CMS_ContentInfo *cms);
-
+#endif
 void cms_DigestAlgorithm_set(X509_ALGOR *alg, const EVP_MD *md);
 BIO *cms_DigestAlgorithm_init_bio(X509_ALGOR *digestAlgorithm);
 int cms_DigestAlgorithm_find_ctx(EVP_MD_CTX *mctx, BIO *chain,
Index: openssl-1.0.1r/crypto/cms/cms_lib.c
===================================================================
--- openssl-1.0.1r.orig/crypto/cms/cms_lib.c	2016-01-28 22:00:36.000000000 +0800
+++ openssl-1.0.1r/crypto/cms/cms_lib.c	2018-09-26 18:40:26.787632312 +0800
@@ -127,10 +127,12 @@
         cmsbio = cms_DigestedData_init_bio(cms);
         break;
 #ifdef ZLIB
+#ifndef OPENSSL_NO_COMP
     case NID_id_smime_ct_compressedData:
         cmsbio = cms_CompressedData_init_bio(cms);
         break;
 #endif
+#endif
 
     case NID_pkcs7_encrypted:
         cmsbio = cms_EncryptedData_init_bio(cms);
